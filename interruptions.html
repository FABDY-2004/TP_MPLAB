<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fiche â€” Interruptions PIC18F4520</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:#fff; color:#1a1a1a; font-family:'Inter',Arial,sans-serif; font-size:13px; line-height:1.45; }
  code, pre, .tt { font-family:'JetBrains Mono',Consolas,monospace; }
  .container { max-width:1100px; margin:0 auto; padding:16px 20px; }

  /* Title */
  .title-box { background:#1e3a5f; color:white; text-align:center; padding:12px 16px; border-radius:3px; margin-bottom:12px; }
  .title-box h1 { font-size:20px; margin-bottom:4px; }
  .title-box .sub { font-size:13px; }
  .title-box .meta { font-size:10px; opacity:0.75; margin-top:3px; }

  /* Section headers */
  .sh { background:#1e3a5f; color:white; font-weight:bold; font-size:13px; padding:5px 10px; border-radius:2px; margin:14px 0 6px; }

  /* Legend */
  .legend { display:flex; flex-wrap:wrap; gap:5px; margin:5px 0 8px; font-size:11px; }
  .legend span { padding:2px 6px; border:1px solid #bbb; }

  /* Tables */
  .ts { overflow-x:auto; margin:4px 0; }
  table { width:100%; border-collapse:collapse; font-size:11px; }
  th,td { padding:4px 6px; border:1px solid #bbb; text-align:center; }
  th { background:#dbeafe; font-weight:600; font-size:10px; }
  .l { text-align:left; }

  /* Cell colors matching LaTeX exactly */
  .cf { background:#FFF3CD; } .ce { background:#D1ECF1; } .cg { background:#D4EDDA; }
  .cp { background:#F8D7DA; } .cm { background:#E2D5F1; } .cu { background:#E9E9E9; color:#888; }

  /* Register maps */
  .rn { font-weight:bold; font-size:13px; text-align:center; margin:10px 0 3px; font-family:'JetBrains Mono',monospace; }
  .rnote { text-align:center; font-size:11px; color:#444; font-style:italic; margin:2px 0 8px; }
  .rt td { min-width:70px; font-family:'JetBrains Mono',monospace; font-size:10px; padding:3px 4px; }
  .rt tr:first-child td { font-size:9.5px; color:#555; }
  .rt tr:nth-child(2) td { font-weight:bold; font-size:10.5px; }
  .rt tr:nth-child(3) td { font-size:9.5px; color:#555; }

  /* Code blocks with syntax colors */
  .cb { background:#f8f9fa; border:1px solid #ddd; border-radius:3px; margin:6px 0; overflow:hidden; }
  .cb pre { padding:8px 10px; overflow-x:auto; font-family:'JetBrains Mono',Consolas,monospace; font-size:11px; line-height:1.55; white-space:pre; }
  /* Syntax classes */
  .kw { color:#1a56db; font-weight:600; }      /* keywords: void, if, unsigned, char, volatile */
  .cm-c { color:#374151; font-style:italic; }   /* comments */
  .rg { color:#92400e; }                        /* register names */
  .hx { color:#9a3412; }                        /* hex values */
  .pp { color:#6b21a8; font-weight:600; }       /* #pragma directives */
  .fn { color:#1a56db; }                        /* function names */

  /* Boxes */
  .box { border-radius:3px; padding:10px 12px; margin:8px 0; border:1px solid; }
  .bt { font-weight:bold; font-size:12px; margin-bottom:4px; }
  .box p { font-size:11px; line-height:1.4; }
  .bb { background:#dbeafe; border-color:#1a56db; } .bb .bt { color:#1a56db; }
  .bp { background:#f3e8ff; border-color:#6b21a8; } .bp .bt { color:#6b21a8; }
  .br { background:#fee2e2; border-color:#991b1b; } .br .bt { color:#991b1b; }
  .bg { background:#dcfce7; border-color:#166534; } .bg .bt { color:#166534; }

  .g2 { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  @media (max-width:800px) { .g2 { grid-template-columns:1fr; } }

  /* Warn table */
  .wt td { text-align:left; font-size:11px; vertical-align:top; }
  .wt td:first-child { font-family:'JetBrains Mono',monospace; font-size:10.5px; }

  /* Config table */
  .ct td { text-align:left; font-size:10px; }
  .sth { font-weight:bold; font-size:11px; padding:5px 8px; }
  .cc { font-family:'JetBrains Mono',monospace; font-size:9.5px; }

  /* Checklist */
  .ck { list-style:none; padding:0; counter-reset:step; }
  .ck li { counter-increment:step; display:flex; align-items:flex-start; gap:8px; padding:5px 0; border-bottom:1px solid #a7d9a7; font-size:11px; }
  .ck li:last-child { border-bottom:none; }
  .ck li::before { content:counter(step) "."; font-weight:bold; min-width:18px; flex-shrink:0; }
  .ck code { background:#d4edda; padding:1px 3px; border-radius:2px; font-family:'JetBrains Mono',monospace; font-size:10.5px; }
  .hi { margin-left:auto; color:#444; font-size:10px; white-space:nowrap; }

  .footer { text-align:center; margin-top:20px; padding:8px; font-size:10px; color:#999; border-top:1px solid #ddd; }
  .small { font-size:11px; color:#374151; }
  @media print { .cb,.box { break-inside:avoid; } .container { padding:8px; } }
</style>
</head>
<body>
<div class="container">

<div class="title-box">
  <h1>FICHE &mdash; Interruptions PIC18F4520</h1>
  <div class="sub">Scrutation drapeau / interruption sans priorit&eacute; / interruption avec priorit&eacute;</div>
  <div class="meta">G21 (Info2) &mdash; TP COL_A_A106 &mdash; GEII Mulhouse &mdash; S&eacute;ance 3 du 18 f&eacute;vrier 2026 (8h30&ndash;12h30)</div>
</div>

<!-- ============ CORRESPONDANCE ============ -->
<div class="sh">Bouton &rarr; Broche &rarr; Interruption &rarr; Bits</div>

<div class="ts"><table>
  <tr><th>Bouton</th><th>Broche</th><th>IT</th><th class="cf">Flag (IF)</th><th class="ce">Enable (IE)</th><th class="cg">Front (INTEDG)</th><th class="cp">Priorit&eacute; (IP)</th></tr>
  <tr><td>BP0</td><td>RB0</td><td>INT0</td><td class="cf">INTCON bit 1</td><td class="ce">INTCON bit 4</td><td class="cg">INTCON2 bit 6</td><td class="cp"><i>toujours haute</i></td></tr>
  <tr><td>BP1</td><td>RB1</td><td>INT1</td><td class="cf">INTCON3 bit 0</td><td class="ce">INTCON3 bit 3</td><td class="cg">INTCON2 bit 5</td><td class="cp">INTCON3 bit 6</td></tr>
  <tr><td>BP2</td><td>RB2</td><td>INT2</td><td class="cf">INTCON3 bit 1</td><td class="ce">INTCON3 bit 4</td><td class="cg">INTCON2 bit 4</td><td class="cp">INTCON3 bit 7</td></tr>
</table></div>

<!-- ============ CARTE DES REGISTRES ============ -->
<div class="sh">Carte des registres (bit par bit)</div>

<div class="legend">
  <span class="cf">IF = Interrupt Flag (voyant)</span>
  <span class="ce">IE = Interrupt Enable (alarme)</span>
  <span class="cg">INTEDG = Front</span>
  <span class="cp">IP = Interrupt Priority</span>
  <span class="cm">GIE = Global Interrupt Enable (disjoncteur)</span>
  <span class="cu">Pas utilis&eacute;</span>
</div>

<div class="rn">INTCON</div>
<div class="ts"><table class="rt">
  <tr><td class="cm">bit 7</td><td class="cm">bit 6</td><td class="cu">bit 5</td><td class="ce">bit 4</td><td class="cu">bit 3</td><td class="cu">bit 2</td><td class="cf">bit 1</td><td class="cu">bit 0</td></tr>
  <tr><td class="cm"><b>GIE/GIEH</b></td><td class="cm"><b>PEIE/GIEL</b></td><td class="cu">TMR0IE</td><td class="ce"><b>INT0IE</b></td><td class="cu">RBIE</td><td class="cu">TMR0IF</td><td class="cf"><b>INT0IF</b></td><td class="cu">RBIF</td></tr>
  <tr><td>0x80</td><td>0x40</td><td>0x20</td><td>0x10</td><td>0x08</td><td>0x04</td><td>0x02</td><td>0x01</td></tr>
</table></div>
<div class="rnote">Bit 7 s'appelle GIE si IPEN=0, ou GIEH (Global Interrupt Enable <b>High</b>) si IPEN=1. Bit 6 s'appelle PEIE si IPEN=0, ou GIEL (<b>Low</b>) si IPEN=1.</div>

<div class="rn">INTCON2</div>
<div class="ts"><table class="rt">
  <tr><td class="cu">bit 7</td><td class="cg">bit 6</td><td class="cg">bit 5</td><td class="cg">bit 4</td><td class="cu">bit 3</td><td class="cu">bit 2</td><td class="cu">bit 1</td><td class="cu">bit 0</td></tr>
  <tr><td class="cu">RBPU</td><td class="cg"><b>INTEDG0</b></td><td class="cg"><b>INTEDG1</b></td><td class="cg"><b>INTEDG2</b></td><td class="cu">---</td><td class="cu">TMR0IP</td><td class="cu">---</td><td class="cu">RBIP</td></tr>
  <tr><td>0x80</td><td>0x40</td><td>0x20</td><td>0x10</td><td></td><td>0x04</td><td></td><td>0x01</td></tr>
</table></div>

<div class="rn">INTCON3</div>
<div class="ts"><table class="rt">
  <tr><td class="cp">bit 7</td><td class="cp">bit 6</td><td class="cu">bit 5</td><td class="ce">bit 4</td><td class="ce">bit 3</td><td class="cu">bit 2</td><td class="cf">bit 1</td><td class="cf">bit 0</td></tr>
  <tr><td class="cp"><b>INT2IP</b></td><td class="cp"><b>INT1IP</b></td><td class="cu">---</td><td class="ce"><b>INT2IE</b></td><td class="ce"><b>INT1IE</b></td><td class="cu">---</td><td class="cf"><b>INT2IF</b></td><td class="cf"><b>INT1IF</b></td></tr>
  <tr><td>0x80</td><td>0x40</td><td></td><td>0x10</td><td>0x08</td><td></td><td>0x02</td><td>0x01</td></tr>
</table></div>

<div class="rn">RCON <span style="font-weight:normal;font-size:11px;color:#444">(seul IPEN nous concerne)</span></div>
<div class="ts"><table class="rt">
  <tr><td class="cp">bit 7</td><td class="cu">bit 6</td><td class="cu">bit 5</td><td class="cu">bit 4</td><td class="cu">bit 3</td><td class="cu">bit 2</td><td class="cu">bit 1</td><td class="cu">bit 0</td></tr>
  <tr><td class="cp"><b>IPEN</b></td><td class="cu">SBOREN</td><td class="cu">---</td><td class="cu">RI</td><td class="cu">TO</td><td class="cu">PD</td><td class="cu">POR</td><td class="cu">BOR</td></tr>
  <tr><td>0x80</td><td>0x40</td><td></td><td>0x10</td><td>0x08</td><td>0x04</td><td>0x02</td><td>0x01</td></tr>
</table></div>

<!-- ============ ISR UNIQUE vs DEUX ISR ============ -->
<div class="sh">ISR unique vs deux ISR : qu'est-ce que ca veut dire ?</div>

<p class="small" style="margin:4px 0 8px"><b>ISR</b> = Interrupt Service Routine = la fonction que le PIC appelle automatiquement quand une interruption se d&eacute;clenche. <b>RAZ</b> = Remise &Agrave; Z&eacute;ro.</p>

<div class="g2">
<div class="box bb">
  <div class="bt">Sans priorit&eacute; (IPEN = 0) : ISR UNIQUE</div>
  <p>Quand IPEN = 0, le PIC ne connait <b>pas</b> les niveaux de priorit&eacute;. Toutes les interruptions (BP0, BP1, BP2&hellip;) arrivent au <b>m&ecirc;me endroit</b> : le <b>vecteur 0x08</b>. Il n'y a donc qu'<b>une seule fonction ISR</b> (isrHaute). &Agrave; l'int&eacute;rieur, on teste chaque flag pour savoir <i>quel</i> bouton a d&eacute;clench&eacute; :</p>
  <div class="cb" style="margin-top:6px">
<pre><span class="pp">#pragma interrupt</span> isrHaute           <span class="cm-c">/* La seule ISR, tout arrive ici         */</span>
<span class="kw">void</span> <span class="fn">isrHaute</span>(<span class="kw">void</span>) {
    <span class="kw">if</span>(<span class="rg">INTCON3</span> &amp; <span class="hx">0x01</span>) { ... }       <span class="cm-c">/* C'etait BP1 ?                         */</span>
    <span class="kw">if</span>(<span class="rg">INTCON3</span> &amp; <span class="hx">0x02</span>) { ... }       <span class="cm-c">/* C'etait BP2 ?                         */</span>
    <span class="kw">if</span>(<span class="rg">INTCON</span>  &amp; <span class="hx">0x02</span>) { ... }       <span class="cm-c">/* C'etait BP0 ?                         */</span>
}</pre>
  </div>
</div>
<div class="box bp">
  <div class="bt">Avec priorit&eacute; (IPEN = 1) : DEUX ISR s&eacute;par&eacute;es</div>
  <p>Quand IPEN = 1, le PIC a <b>deux niveaux</b>. Les interruptions hautes vont au <b>vecteur 0x08</b> (isrHaute), les basses au <b>vecteur 0x18</b> (isrBasse). On a donc <b>deux fonctions ISR</b> distinctes. La haute peut <b>interrompre</b> la basse, pas l'inverse :</p>
  <div class="cb" style="margin-top:6px">
<pre><span class="pp">#pragma interrupt</span> isrHaute           <span class="cm-c">/* Vecteur 0x08 : haute priorite         */</span>
<span class="kw">void</span> <span class="fn">isrHaute</span>(<span class="kw">void</span>) {
    <span class="kw">if</span>(<span class="rg">INTCON3</span> &amp; <span class="hx">0x01</span>) { ... }       <span class="cm-c">/* BP1 (configure en haute)              */</span>
}

<span class="pp">#pragma interruptlow</span> isrBasse        <span class="cm-c">/* Vecteur 0x18 : basse priorite         */</span>
<span class="kw">void</span> <span class="fn">isrBasse</span>(<span class="kw">void</span>) {
    <span class="kw">if</span>(<span class="rg">INTCON3</span> &amp; <span class="hx">0x02</span>) { ... }       <span class="cm-c">/* BP2 (configure en basse)              */</span>
}</pre>
  </div>
</div>
</div>

<!-- ============ QUOI CONFIGURER ============ -->
<div class="sh">Quoi configurer selon le mode</div>

<div class="ts"><table>
  <tr><th class="l">&Eacute;tape</th><th>Scrutation drapeau</th><th>interruption sans priorit&eacute;</th><th>interruption avec priorit&eacute;</th></tr>
  <tr><td class="l cg">Front descendant (INTEDG = 0)</td><td>OUI</td><td>OUI</td><td>OUI</td></tr>
  <tr><td class="l cf">Effacer le voyant (IF = 0)</td><td>OUI</td><td>OUI</td><td>OUI</td></tr>
  <tr><td class="l ce">Activer l'alarme (IE = 1)</td><td>NON</td><td>OUI</td><td>OUI</td></tr>
  <tr><td class="l cp">Choisir priorit&eacute; (IP)</td><td>NON</td><td>NON</td><td>OUI</td></tr>
  <tr><td class="l cp">Activer mode priorit&eacute; (IPEN = 1)</td><td>NON</td><td>NON</td><td>OUI</td></tr>
  <tr><td class="l cm">GIE = 1</td><td>NON</td><td>OUI (<code>0x80</code>)</td><td>NON</td></tr>
  <tr><td class="l cm">GIEH + GIEL = 1</td><td>NON</td><td>NON</td><td>OUI (<code>0xC0</code>)</td></tr>
  <tr style="font-weight:bold"><td class="l">Nombre d'ISR</td><td>0 (pas d'ISR)</td><td>1 (ISR unique)</td><td>2 (haute + basse)</td></tr>
  <tr style="font-weight:bold"><td class="l">O&ugrave; tester les flags ?</td><td>dans le while(1)</td><td>dans l'ISR</td><td>dans les ISR</td></tr>
</table></div>

<!-- ============ SCRUTATION ============ -->
<div class="sh">Mode 1 : Scrutation drapeau (pas d'ISR, on teste dans la boucle)</div>

<div class="cb">
<pre><span class="cm-c">/* === Configuration (dans le main, avant le while) === */</span>
<span class="rg">TRISB</span> = <span class="rg">TRISB</span> | <span class="hx">0x06</span>;                   <span class="cm-c">/* RB1 et RB2 en entree                         */</span>
<span class="rg">INTCON2</span> = <span class="rg">INTCON2</span> &amp; (~<span class="hx">0x20</span>);            <span class="cm-c">/* INTEDG1=0 : front descendant BP1              */</span>
<span class="rg">INTCON2</span> = <span class="rg">INTCON2</span> &amp; (~<span class="hx">0x10</span>);            <span class="cm-c">/* INTEDG2=0 : front descendant BP2              */</span>
<span class="rg">INTCON3</span> = <span class="rg">INTCON3</span> &amp; (~<span class="hx">0x01</span>);            <span class="cm-c">/* INT1IF=0 : voyant BP1 eteint au demarrage     */</span>
<span class="rg">INTCON3</span> = <span class="rg">INTCON3</span> &amp; (~<span class="hx">0x02</span>);            <span class="cm-c">/* INT2IF=0 : voyant BP2 eteint au demarrage     */</span>
<span class="cm-c">/* PAS de IE, PAS de GIE, PAS de priorite, PAS d'ISR */</span>

<span class="cm-c">/* === Dans le while(1) : on regarde les voyants nous-memes === */</span>
<span class="kw">if</span>(<span class="rg">INTCON3</span> &amp; <span class="hx">0x01</span>)                      <span class="cm-c">/* Voyant BP1 allume ?                           */</span>
{
    <span class="rg">INTCON3</span> = <span class="rg">INTCON3</span> &amp; (~<span class="hx">0x01</span>);        <span class="cm-c">/* Eteindre le voyant (obligatoire)              */</span>
    <span class="cm-c">/* action BP1 */</span>
}
<span class="kw">if</span>(<span class="rg">INTCON3</span> &amp; <span class="hx">0x02</span>)                      <span class="cm-c">/* Voyant BP2 allume ?                           */</span>
{
    <span class="rg">INTCON3</span> = <span class="rg">INTCON3</span> &amp; (~<span class="hx">0x02</span>);        <span class="cm-c">/* Eteindre le voyant                            */</span>
    <span class="cm-c">/* action BP2 */</span>
}</pre>
</div>

<!-- ============ IT SANS PRIORITE ============ -->
<div class="sh">Mode 2 : Interruption SANS priorit&eacute; (ISR unique au vecteur 0x08)</div>

<p class="small" style="margin:3px 0 6px"><b>ISR unique</b> = IPEN est &agrave; 0, donc le PIC n'a qu'un seul niveau. <b>Toutes</b> les interruptions (BP0, BP1, BP2) arrivent au m&ecirc;me vecteur 0x08. Dans l'ISR, on teste chaque flag pour savoir lequel a d&eacute;clench&eacute;.</p>

<div class="cb">
<pre><span class="cm-c">/* === Configuration (dans le main, avant le while) === */</span>
<span class="rg">TRISB</span> = <span class="rg">TRISB</span> | <span class="hx">0x06</span>;                   <span class="cm-c">/* RB1 et RB2 en entree                         */</span>
<span class="rg">INTCON2</span> = <span class="rg">INTCON2</span> &amp; (~<span class="hx">0x20</span>);            <span class="cm-c">/* INTEDG1=0 : front descendant BP1              */</span>
<span class="rg">INTCON2</span> = <span class="rg">INTCON2</span> &amp; (~<span class="hx">0x10</span>);            <span class="cm-c">/* INTEDG2=0 : front descendant BP2              */</span>
<span class="rg">INTCON3</span> = <span class="rg">INTCON3</span> &amp; (~<span class="hx">0x01</span>);            <span class="cm-c">/* Effacer INT1IF                                */</span>
<span class="rg">INTCON3</span> = <span class="rg">INTCON3</span> &amp; (~<span class="hx">0x02</span>);            <span class="cm-c">/* Effacer INT2IF                                */</span>
<span class="rg">INTCON3</span> = <span class="rg">INTCON3</span> | <span class="hx">0x08</span>;              <span class="cm-c">/* INT1IE=1 : activer alarme BP1                 */</span>
<span class="rg">INTCON3</span> = <span class="rg">INTCON3</span> | <span class="hx">0x10</span>;              <span class="cm-c">/* INT2IE=1 : activer alarme BP2                 */</span>
<span class="rg">INTCON</span>  = <span class="rg">INTCON</span>  | <span class="hx">0x80</span>;              <span class="cm-c">/* GIE=1 : disjoncteur general EN DERNIER        */</span>

<span class="cm-c">/* === ISR unique (tout arrive a 0x08, on teste chaque flag) === */</span>
<span class="kw">void</span> <span class="fn">isrHaute</span>(<span class="kw">void</span>) {
    <span class="kw">if</span>(<span class="rg">INTCON3</span> &amp; <span class="hx">0x01</span>) {                <span class="cm-c">/* C'etait BP1 ?                                 */</span>
        <span class="rg">INTCON3</span> = <span class="rg">INTCON3</span> &amp; (~<span class="hx">0x01</span>);    <span class="cm-c">/* Eteindre le voyant                            */</span>
        <span class="cm-c">/* action BP1 */</span>
    }
    <span class="kw">if</span>(<span class="rg">INTCON3</span> &amp; <span class="hx">0x02</span>) {                <span class="cm-c">/* C'etait BP2 ?                                 */</span>
        <span class="rg">INTCON3</span> = <span class="rg">INTCON3</span> &amp; (~<span class="hx">0x02</span>);    <span class="cm-c">/* Eteindre le voyant                            */</span>
        <span class="cm-c">/* action BP2 */</span>
    }
}</pre>
</div>

<!-- ============ IT AVEC PRIORITE ============ -->
<div class="sh">Mode 3 : Interruption AVEC priorit&eacute; (deux ISR : 0x08 + 0x18)</div>

<p class="small" style="margin:3px 0 6px"><b>Deux ISR</b> = IPEN est &agrave; 1, donc 2 niveaux. Chaque interruption est assign&eacute;e haute ou basse via son bit IP. Les hautes vont &agrave; 0x08 (isrHaute), les basses &agrave; 0x18 (isrBasse). La haute peut interrompre la basse.</p>

<div class="cb">
<pre><span class="cm-c">/* === Configuration (dans le main, avant le while) === */</span>
<span class="rg">TRISB</span> = <span class="rg">TRISB</span> | <span class="hx">0x06</span>;                   <span class="cm-c">/* RB1 et RB2 en entree                         */</span>
<span class="rg">RCON</span>  = <span class="rg">RCON</span>  | <span class="hx">0x80</span>;                  <span class="cm-c">/* IPEN=1 : activer le mode 2 niveaux            */</span>

<span class="cm-c">/* INT1 (BP1) : HAUTE priorite */</span>
<span class="rg">INTCON2</span> = <span class="rg">INTCON2</span> &amp; (~<span class="hx">0x20</span>);            <span class="cm-c">/* INTEDG1=0 : front descendant                  */</span>
<span class="rg">INTCON3</span> = <span class="rg">INTCON3</span> &amp; (~<span class="hx">0x01</span>);            <span class="cm-c">/* Effacer INT1IF                                */</span>
<span class="rg">INTCON3</span> = <span class="rg">INTCON3</span> | <span class="hx">0x40</span>;              <span class="cm-c">/* INT1IP=1 : HAUTE priorite                     */</span>
<span class="rg">INTCON3</span> = <span class="rg">INTCON3</span> | <span class="hx">0x08</span>;              <span class="cm-c">/* INT1IE=1 : activer alarme                     */</span>

<span class="cm-c">/* INT2 (BP2) : BASSE priorite */</span>
<span class="rg">INTCON2</span> = <span class="rg">INTCON2</span> &amp; (~<span class="hx">0x10</span>);            <span class="cm-c">/* INTEDG2=0 : front descendant                  */</span>
<span class="rg">INTCON3</span> = <span class="rg">INTCON3</span> &amp; (~<span class="hx">0x02</span>);            <span class="cm-c">/* Effacer INT2IF                                */</span>
<span class="rg">INTCON3</span> = <span class="rg">INTCON3</span> &amp; (~<span class="hx">0x80</span>);            <span class="cm-c">/* INT2IP=0 : BASSE priorite                     */</span>
<span class="rg">INTCON3</span> = <span class="rg">INTCON3</span> | <span class="hx">0x10</span>;              <span class="cm-c">/* INT2IE=1 : activer alarme                     */</span>

<span class="rg">INTCON</span>  = <span class="rg">INTCON</span>  | <span class="hx">0xC0</span>;              <span class="cm-c">/* GIEH+GIEL=1 : les 2 disjoncteurs EN DERNIER   */</span>

<span class="cm-c">/* === ISR haute (vecteur 0x08) --- #pragma interrupt === */</span>
<span class="kw">void</span> <span class="fn">isrHaute</span>(<span class="kw">void</span>) {
    <span class="kw">if</span>(<span class="rg">INTCON3</span> &amp; <span class="hx">0x01</span>) {
        <span class="rg">INTCON3</span> = <span class="rg">INTCON3</span> &amp; (~<span class="hx">0x01</span>);
        <span class="cm-c">/* action BP1 (haute priorite) */</span>
    }
}

<span class="cm-c">/* === ISR basse (vecteur 0x18) --- #pragma interruptlow === */</span>
<span class="kw">void</span> <span class="fn">isrBasse</span>(<span class="kw">void</span>) {
    <span class="kw">if</span>(<span class="rg">INTCON3</span> &amp; <span class="hx">0x02</span>) {
        <span class="rg">INTCON3</span> = <span class="rg">INTCON3</span> &amp; (~<span class="hx">0x02</span>);
        <span class="cm-c">/* action BP2 (basse priorite) */</span>
    }
}</pre>
</div>

<!-- ============ STRUCTURE ISR ============ -->
<div class="sh">Structure des vecteurs et ISR (Interrupt Service Routine)</div>

<div class="cb">
<pre><span class="kw">volatile unsigned char</span> maVariable = <span class="hx">1</span>;  <span class="cm-c">/* volatile OBLIGATOIRE si partagee main/ISR     */</span>
<span class="kw">void</span> <span class="fn">isrHaute</span>(<span class="kw">void</span>);                    <span class="cm-c">/* Prototype OBLIGATOIRE (sinon erreur au GOTO)  */</span>

<span class="pp">#pragma code</span> vecteur_haute = <span class="hx">0x08</span>       <span class="cm-c">/* Place le code a l'adresse 0x08                */</span>
<span class="kw">void</span> <span class="fn">VecteurHaute</span>(<span class="kw">void</span>) {
    _asm GOTO isrHaute _endasm          <span class="cm-c">/* Le PIC saute ici, on redirige vers l'ISR      */</span>
}
<span class="pp">#pragma code</span>                            <span class="cm-c">/* Fin du placement force                        */</span>

<span class="pp">#pragma interrupt</span> isrHaute              <span class="cm-c">/* Directive haute priorite                      */</span>
<span class="kw">void</span> <span class="fn">isrHaute</span>(<span class="kw">void</span>) {
    <span class="cm-c">/* tester flag, effacer flag, faire l'action */</span>
}

<span class="cm-c">/* --- Seulement si IPEN = 1 (mode avec priorite) --- */</span>
<span class="kw">void</span> <span class="fn">isrBasse</span>(<span class="kw">void</span>);                    <span class="cm-c">/* Prototype                                     */</span>

<span class="pp">#pragma code</span> vecteur_basse = <span class="hx">0x18</span>
<span class="kw">void</span> <span class="fn">VecteurBasse</span>(<span class="kw">void</span>) {
    _asm GOTO isrBasse _endasm
}
<span class="pp">#pragma code</span>

<span class="pp">#pragma interruptlow</span> isrBasse           <span class="cm-c">/* Directive BASSE priorite (pas "interrupt")    */</span>
<span class="kw">void</span> <span class="fn">isrBasse</span>(<span class="kw">void</span>) {
    <span class="cm-c">/* tester flag, effacer flag, faire l'action */</span>
}</pre>
</div>

<!-- ============ MASQUES ============ -->
<div class="sh">Memento masques (position du bit &rarr; valeur hexa)</div>

<div class="ts"><table>
  <tr><th>Bit</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th></tr>
  <tr><td style="font-weight:bold">Masque</td><td class="tt">0x01</td><td class="tt">0x02</td><td class="tt">0x04</td><td class="tt">0x08</td><td class="tt">0x10</td><td class="tt">0x20</td><td class="tt">0x40</td><td class="tt">0x80</td></tr>
</table></div>

<div class="ts" style="margin-top:4px"><table>
  <tr><th class="l">Je veux&hellip;</th><th class="l">Code</th><th class="l">Exemple</th></tr>
  <tr><td class="l">Mettre un bit a <b>1</b></td><td class="l tt">REG = REG | masque;</td><td class="l tt">INTCON3 = INTCON3 | 0x08;</td></tr>
  <tr><td class="l">Mettre un bit a <b>0</b></td><td class="l tt">REG = REG &amp; (~masque);</td><td class="l tt">INTCON3 = INTCON3 &amp; (~0x01);</td></tr>
  <tr><td class="l"><b>Tester</b> un bit</td><td class="l tt">if(REG &amp; masque)</td><td class="l tt">if(INTCON3 &amp; 0x01)</td></tr>
</table></div>

<!-- ============ ERREURS ============ -->
<div class="box br" style="margin-top:12px">
  <div class="bt">Erreurs frequentes</div>
  <table class="wt" style="width:100%">
    <tr><td><code>Delay10KTCYx(125);</code> dans l'ISR</td><td><b>NON !</b> Jamais de Delay dans une ISR.</td></tr>
    <tr><td>Oublier le prototype</td><td>Le compilateur ne connait pas <code>isrHaute</code> au moment du GOTO.</td></tr>
    <tr><td>Oublier <code>volatile</code></td><td>Le main ne voit jamais le changement fait par l'ISR.</td></tr>
    <tr><td>GIE = 1 avant la config</td><td>Une interruption peut arriver avant que tout soit pr&ecirc;t.</td></tr>
    <tr><td><code>RCON | 0x08</code> pour IPEN</td><td><b>NON !</b> IPEN = bit 7 = <code>0x80</code>, pas <code>0x08</code>.</td></tr>
    <tr><td><code>INTCON3 = 0x00;</code></td><td><b>NON !</b> Ecrase tout. Utiliser <code>INTCON3 = INTCON3 &amp; (~0x01);</code></td></tr>
    <tr><td><code>#pragma interrupt</code> pour basse</td><td><b>NON !</b> C'est <code>#pragma interruptlow</code> pour la basse priorit&eacute;.</td></tr>
  </table>
</div>

<!-- ============ RECAP ============ -->
<div class="sh" style="margin-top:20px">Tableau r&eacute;capitulatif : chaque bouton, chaque registre, chaque masque</div>

<p class="small" style="margin:3px 0 6px">Ce tableau corrige les erreurs du tableau manuscrit (BP1 avait INT0IF/INT2IE/INT2IP/INTCONB au lieu de INT1IF/INT1IE/INT1IP/INTCON3).</p>

<div class="ts"><table>
  <tr><th>Bouton</th><th class="l">Quoi / Nature</th><th>Registre</th><th>Bit</th><th>Masque</th><th class="l">Code pour configurer</th></tr>
  <tr><td rowspan="4" style="font-weight:bold">BP0 / INT0</td><td class="l cf">Voyant (INT0IF)</td><td>INTCON</td><td>bit 1</td><td class="tt">0x02</td><td class="l tt">INTCON = INTCON &amp; (~0x02);</td></tr>
  <tr><td class="l ce">Alarme (INT0IE)</td><td>INTCON</td><td>bit 4</td><td class="tt">0x10</td><td class="l tt">INTCON = INTCON | 0x10;</td></tr>
  <tr><td class="l cp">Priorit&eacute; (INT0IP)</td><td colspan="3" style="font-style:italic;color:#666"><i>n'existe pas</i></td><td class="l" style="font-style:italic;color:#666">INT0 est TOUJOURS haute priorit&eacute;</td></tr>
  <tr><td class="l cg">Front (INTEDG0)</td><td>INTCON2</td><td>bit 6</td><td class="tt">0x40</td><td class="l tt">INTCON2 = INTCON2 &amp; (~0x40);</td></tr>
  <tr><td rowspan="4" style="font-weight:bold">BP1 / INT1</td><td class="l cf">Voyant (<b>INT1IF</b>)</td><td><b>INTCON3</b></td><td>bit 0</td><td class="tt">0x01</td><td class="l tt">INTCON3 = INTCON3 &amp; (~0x01);</td></tr>
  <tr><td class="l ce">Alarme (<b>INT1IE</b>)</td><td><b>INTCON3</b></td><td>bit 3</td><td class="tt">0x08</td><td class="l tt">INTCON3 = INTCON3 | 0x08;</td></tr>
  <tr><td class="l cp">Priorit&eacute; (<b>INT1IP</b>)</td><td><b>INTCON3</b></td><td>bit 6</td><td class="tt">0x40</td><td class="l tt">INTCON3 = INTCON3 | 0x40; <span style="font-size:9px;color:#666">(haute)</span></td></tr>
  <tr><td class="l cg">Front (INTEDG1)</td><td>INTCON2</td><td>bit 5</td><td class="tt">0x20</td><td class="l tt">INTCON2 = INTCON2 &amp; (~0x20);</td></tr>
  <tr><td rowspan="4" style="font-weight:bold">BP2 / INT2</td><td class="l cf">Voyant (INT2IF)</td><td>INTCON3</td><td>bit 1</td><td class="tt">0x02</td><td class="l tt">INTCON3 = INTCON3 &amp; (~0x02);</td></tr>
  <tr><td class="l ce">Alarme (INT2IE)</td><td>INTCON3</td><td>bit 4</td><td class="tt">0x10</td><td class="l tt">INTCON3 = INTCON3 | 0x10;</td></tr>
  <tr><td class="l cp">Priorit&eacute; (INT2IP)</td><td>INTCON3</td><td>bit 7</td><td class="tt">0x80</td><td class="l tt">INTCON3 = INTCON3 &amp; (~0x80); <span style="font-size:9px;color:#666">(basse)</span></td></tr>
  <tr><td class="l cg">Front (INTEDG2)</td><td>INTCON2</td><td>bit 4</td><td class="tt">0x10</td><td class="l tt">INTCON2 = INTCON2 &amp; (~0x10);</td></tr>
  <tr><td colspan="2" class="l cm" style="font-weight:bold">Disjoncteur GIE (sans priorit&eacute;)</td><td>INTCON</td><td>bit 7</td><td class="tt">0x80</td><td class="l tt">INTCON = INTCON | 0x80;</td></tr>
  <tr><td colspan="2" class="l cm" style="font-weight:bold">Disjoncteurs GIEH + GIEL (avec priorit&eacute;)</td><td>INTCON</td><td>bits 7+6</td><td class="tt">0xC0</td><td class="l tt">INTCON = INTCON | 0xC0;</td></tr>
  <tr><td colspan="2" class="l cp" style="font-weight:bold">Activer mode priorit&eacute; (IPEN)</td><td>RCON</td><td>bit 7</td><td class="tt">0x80</td><td class="l tt">RCON = RCON | 0x80;</td></tr>
</table></div>

<!-- ============ CONFIG DETAILLEE ============ -->
<div class="sh" style="margin-top:14px">Configuration d&eacute;taill&eacute;e : code exact pour chaque mode et chaque bouton</div>

<div class="ts"><table class="ct">
  <tr><th class="l">&Eacute;tape (dans l'ordre !)</th><th class="l">Scrutation drapeau</th><th class="l">interruption sans priorit&eacute;</th><th class="l">interruption avec priorit&eacute;</th></tr>
  <tr><td colspan="4" class="sth cg"><b>1. Front descendant (d&eacute;tecter l'appui)</b></td></tr>
  <tr><td class="l">BP0</td><td class="cc">INTCON2 = INTCON2 &amp; (~0x40);</td><td class="cc">INTCON2 = INTCON2 &amp; (~0x40);</td><td class="cc">INTCON2 = INTCON2 &amp; (~0x40);</td></tr>
  <tr><td class="l">BP1</td><td class="cc">INTCON2 = INTCON2 &amp; (~0x20);</td><td class="cc">INTCON2 = INTCON2 &amp; (~0x20);</td><td class="cc">INTCON2 = INTCON2 &amp; (~0x20);</td></tr>
  <tr><td class="l">BP2</td><td class="cc">INTCON2 = INTCON2 &amp; (~0x10);</td><td class="cc">INTCON2 = INTCON2 &amp; (~0x10);</td><td class="cc">INTCON2 = INTCON2 &amp; (~0x10);</td></tr>
  <tr><td colspan="4" class="sth cf"><b>2. Effacer les voyants (partir propre)</b></td></tr>
  <tr><td class="l">BP0</td><td class="cc">INTCON  = INTCON  &amp; (~0x02);</td><td class="cc">INTCON  = INTCON  &amp; (~0x02);</td><td class="cc">INTCON  = INTCON  &amp; (~0x02);</td></tr>
  <tr><td class="l">BP1</td><td class="cc">INTCON3 = INTCON3 &amp; (~0x01);</td><td class="cc">INTCON3 = INTCON3 &amp; (~0x01);</td><td class="cc">INTCON3 = INTCON3 &amp; (~0x01);</td></tr>
  <tr><td class="l">BP2</td><td class="cc">INTCON3 = INTCON3 &amp; (~0x02);</td><td class="cc">INTCON3 = INTCON3 &amp; (~0x02);</td><td class="cc">INTCON3 = INTCON3 &amp; (~0x02);</td></tr>
  <tr><td colspan="4" class="sth cp"><b>3. Mode priorit&eacute; (seulement si interruption avec priorit&eacute;)</b></td></tr>
  <tr><td class="l">IPEN</td><td style="color:#999">---</td><td style="color:#999">---</td><td class="cc">RCON = RCON | 0x80;</td></tr>
  <tr><td colspan="4" class="sth cp"><b>4. Choisir la priorit&eacute; de chaque IT</b></td></tr>
  <tr><td class="l">BP0</td><td style="color:#999">---</td><td style="color:#999">---</td><td class="l" style="font-style:italic;color:#666">toujours haute (pas de bit IP)</td></tr>
  <tr><td class="l">BP1 haute</td><td style="color:#999">---</td><td style="color:#999">---</td><td class="cc">INTCON3 = INTCON3 | 0x40;</td></tr>
  <tr><td class="l">BP1 basse</td><td style="color:#999">---</td><td style="color:#999">---</td><td class="cc">INTCON3 = INTCON3 &amp; (~0x40);</td></tr>
  <tr><td class="l">BP2 haute</td><td style="color:#999">---</td><td style="color:#999">---</td><td class="cc">INTCON3 = INTCON3 | 0x80;</td></tr>
  <tr><td class="l">BP2 basse</td><td style="color:#999">---</td><td style="color:#999">---</td><td class="cc">INTCON3 = INTCON3 &amp; (~0x80);</td></tr>
  <tr><td colspan="4" class="sth ce"><b>5. Activer les alarmes (seulement si interruption)</b></td></tr>
  <tr><td class="l">BP0</td><td style="color:#999">---</td><td class="cc">INTCON  = INTCON  | 0x10;</td><td class="cc">INTCON  = INTCON  | 0x10;</td></tr>
  <tr><td class="l">BP1</td><td style="color:#999">---</td><td class="cc">INTCON3 = INTCON3 | 0x08;</td><td class="cc">INTCON3 = INTCON3 | 0x08;</td></tr>
  <tr><td class="l">BP2</td><td style="color:#999">---</td><td class="cc">INTCON3 = INTCON3 | 0x10;</td><td class="cc">INTCON3 = INTCON3 | 0x10;</td></tr>
  <tr><td colspan="4" class="sth cm"><b>6. Disjoncteur g&eacute;n&eacute;ral EN DERNIER (sinon une interruption arrive avant que tout soit pr&ecirc;t !)</b></td></tr>
  <tr><td class="l">GIE seul</td><td style="color:#999">---</td><td class="cc">INTCON = INTCON | 0x80;</td><td style="color:#999">---</td></tr>
  <tr><td class="l">GIEH + GIEL</td><td style="color:#999">---</td><td style="color:#999">---</td><td class="cc">INTCON = INTCON | 0xC0;</td></tr>
</table></div>

<!-- ============ CHECKLIST ============ -->
<div class="box bg" style="margin-top:14px">
  <div class="bt">Checklist interruption (dans l'ordre !)</div>
  <ul class="ck">
    <li><div><code>TRISB = TRISB | masque;</code></div><span class="hi">Configurer la broche en entr&eacute;e</span></li>
    <li><div><code>INTCON2 = INTCON2 &amp; (~masque_edge);</code></div><span class="hi">Front descendant (d&eacute;tection appui)</span></li>
    <li><div><code>registre = registre &amp; (~masque_flag);</code></div><span class="hi">Effacer le voyant (partir propre)</span></li>
    <li><div><i>(si priorit&eacute;)</i> <code>RCON = RCON | 0x80;</code></div><span class="hi">Activer mode priorit&eacute; (IPEN=1)</span></li>
    <li><div><i>(si priorit&eacute;)</i> configurer IP (haute = | masque, basse = &amp; ~masque)</div><span class="hi">Choisir le niveau</span></li>
    <li><div><code>registre = registre | masque_enable;</code></div><span class="hi">Activer l'alarme (IE=1)</span></li>
    <li><div><code>INTCON = INTCON | 0x80;</code> <i>(ou 0xC0 si priorit&eacute;)</i></div><span class="hi"><b>Disjoncteur EN DERNIER !</b></span></li>
  </ul>
</div>

<div class="footer">G21 (Info2) &mdash; S&eacute;ance 3 &mdash; 18/02/2026 &mdash; PIC18F4520 @ 10&thinsp;MHz</div>

</div>
</body>
</html>
